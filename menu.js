// menu.js

const ALPHABET_GROUPS = {
  "A-B": "AB".split(""), "C-D": "CD".split(""), "E-F": "EF".split(""),
  "G-H": "GH".split(""), "I-J": "IJ".split(""), "K-L": "KL".split(""),
  "M-N": "MN".split(""), "O-P": "OP".split(""), "Q-R": "QR".split(""),
  "S-T": "ST".split(""), "U-V": "UV".split(""), "W-Z": "WXYZ".split("")
};

// --- 1. ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å Admin (Carousel) ---
function getAdminMenu() {
  return {
    type: "carousel",
    contents: [
      {
        type: "bubble",
        header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "1. ‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏£‡πâ‡∏≤‡∏á", weight: "bold", color: "#1DB446", size: "lg" }] },
        body: {
          type: "box", layout: "vertical", spacing: "md",
          contents: [
            { type: "button", style: "secondary", height: "sm", action: { type: "message", label: "üë§ ‡∏™‡∏£‡πâ‡∏≤‡∏á Owner", text: "U[ID] [‡∏ä‡∏∑‡πà‡∏≠]" } },
            { type: "button", style: "secondary", height: "sm", action: { type: "message", label: "üìç ‡∏™‡∏£‡πâ‡∏≤‡∏á Branch", text: "Branch [‡∏ä‡∏∑‡πà‡∏≠]" } },
            { type: "button", style: "primary", color: "#1DB446", height: "sm", action: { type: "message", label: "üîó ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà", text: "SELECT_GROUP_StartMatch" } }
          ]
        }
      },
      {
        type: "bubble",
        header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "2. ‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£", weight: "bold", color: "#464a4d", size: "lg" }] },
        body: {
          type: "box", layout: "vertical", spacing: "md",
          contents: [
            { type: "button", style: "secondary", height: "sm", action: { type: "message", label: "üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Owner", text: "SELECT_GROUP_Owner" } },
            { type: "button", style: "secondary", height: "sm", action: { type: "message", label: "üìç ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Branch", text: "SELECT_GROUP_Branch" } },
            { type: "button", style: "primary", color: "#464a4d", height: "sm", action: { type: "message", label: "üìã ‡∏î‡∏π‡∏Ñ‡∏π‡πà (‡∏•‡∏ö)", text: "SELECT_GROUP_Map" } }
          ]
        }
      }
    ]
  };
}

// --- 2. ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å Rich Menu) ---
function getReportSelectionMenu() {
  return {
    type: "bubble",
    header: { type: "box", layout: "vertical", backgroundColor: "#00b900", contents: [{ type: "text", text: "üìà ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô", color: "#ffffff", weight: "bold" }] },
    body: {
      type: "box", layout: "vertical", spacing: "sm",
      contents: [
        { type: "button", style: "primary", color: "#00b900", action: { type: "message", label: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤", text: "REPORT_BRANCH_SELECT" } },
        { type: "button", style: "secondary", action: { type: "message", label: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", text: "REPORT_MONTHLY_TOTAL" } },
        { type: "button", style: "secondary", action: { type: "message", label: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á", text: "REPORT_MACHINE_SELECT" } }
      ]
    }
  };
}

// --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Logic: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ ---
// menu.js

async function handleBranchReportLogic(event, supabase, client) {
  try {
    const { data: mapping, error } = await supabase
      .from('owner_branch_mapping')
      .select('branch_id, branches(branch_name)')
      .eq('owner_line_id', event.source.userId);

    if (error || !mapping || mapping.length === 0) {
      return client.replyMessage(event.replyToken, { type: 'text', text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞' });
    }

    // menu.js (‡πÉ‡∏ô handleBranchReportLogic)

    if (mapping.length === 1) {
      // ‡∏ï‡∏±‡∏î await ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° text ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡πà‡∏á‡πÉ‡∏ä‡πâ replyToken
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á Flex ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
      return sendBranchReport(event, mapping[0].branch_id, mapping[0].branches.branch_name, supabase, client);
    }

  } catch (err) {
    console.error(err);
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á replyMessage ‡πÉ‡∏ô catch ‡∏ñ‡πâ‡∏≤‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Token ‡∏ã‡πâ‡∏≥
  }
}

// --- 4. ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤) ---
function getBranchSelectMenu(mapping) {
  return {
    type: "bubble",
    body: {
      type: "box", layout: "vertical", spacing: "sm",
      contents: [
        { type: "text", text: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π", weight: "bold", size: "lg" },
        ...mapping.map(m => ({
          type: "button", style: "secondary", height: "sm",
          action: { 
            type: "message", 
            label: m.branches.branch_name, 
            text: `VIEW_REPORT_ID:${m.branch_id}|${m.branches.branch_name}` 
          }
        }))
      ]
    }
  };
}

// --- 5. Helper Function ---
function chunkArray(arr, s) { 
  const res = []; 
  for (let i = 0; i < arr.length; i += s) res.push(arr.slice(i, i + s)); 
  return res; 
}
async function sendBranchReport(event, branchId, branchName, supabase, client) {
  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ
  const { data: logs, error } = await supabase
    .from('transactions') // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏£‡∏°‡∏£‡∏±‡∏ô SQL ‡πÑ‡∏ß‡πâ
    .select('*')
    .eq('branch_id', branchId);

  if (error) return client.replyMessage(event.replyToken, { type: 'text', text: '‡∏Ñ‡πç‡∏≤‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏∞' });

  const now = new Date();
  let dayTotal = 0, weekTotal = 0, monthTotal = 0;
  let coin = 0, bank = 0, qr = 0;

  logs.forEach(log => {
    const logDate = new Date(log.created_at);
    const diffTime = Math.abs(now - logDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    // ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    if (log.type === 'coin') coin += log.amount;
    else if (log.type === 'bank') bank += log.amount;
    else if (log.type === 'qr') qr += log.amount;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    if (diffDays <= 1) dayTotal += log.amount;
    if (diffDays <= 7) weekTotal += log.amount;
    if (diffDays <= 30) monthTotal += log.amount;
  });

  // ‡∏™‡πà‡∏á Flex Message ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î (‡πÄ‡∏£‡∏¢‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô JSON ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏∞)
  return client.replyMessage(event.replyToken, {
    type: "flex",
    altText: `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ ${branchName}`,
    contents: {
      type: "bubble",
      header: { type: "box", layout: "vertical", backgroundColor: "#00b900", contents: [{ type: "text", text: `üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤: ${branchName}`, color: "#ffffff", weight: "bold" }] },
      body: {
        type: "box", layout: "vertical", spacing: "md",
        contents: [
          { type: "text", text: "‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)", weight: "bold", size: "sm", color: "#888888" },
          { type: "box", layout: "horizontal", contents: [{ type: "text", text: "ü™ô ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç:" }, { type: "text", text: `‡∏ø${coin.toLocaleString()}`, align: "end", weight: "bold" }] },
          { type: "box", layout: "horizontal", contents: [{ type: "text", text: "üíµ ‡∏ò‡∏ô‡∏ö‡∏±‡∏ï‡∏£:" }, { type: "text", text: `‡∏ø${bank.toLocaleString()}`, align: "end", weight: "bold" }] },
          { type: "box", layout: "horizontal", contents: [{ type: "text", text: "üì± QR Code:" }, { type: "text", text: `‡∏ø${qr.toLocaleString()}`, align: "end", weight: "bold" }] },
          { type: "separator", margin: "md" },
          { type: "text", text: "‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤", weight: "bold", size: "sm", color: "#888888" },
          { type: "box", layout: "horizontal", contents: [{ type: "text", text: "üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:" }, { type: "text", text: `‡∏ø${dayTotal.toLocaleString()}`, align: "end", color: "#1DB446", weight: "bold" }] },
          { type: "box", layout: "horizontal", contents: [{ type: "text", text: "üìÖ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ:" }, { type: "text", text: `‡∏ø${weekTotal.toLocaleString()}`, align: "end", weight: "bold" }] },
          { type: "box", layout: "horizontal", contents: [{ type: "text", text: "üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:" }, { type: "text", text: `‡∏ø${monthTotal.toLocaleString()}`, align: "end", weight: "bold" }] }
        ]
      }
    }
  });
}

// --- 6. Export ---
module.exports = {
  getAdminMenu,
  getReportSelectionMenu,
  getBranchSelectMenu,
  sendBranchReport,
  handleBranchReportLogic,
  ALPHABET_GROUPS,
  chunkArray
};
